{% extends 'adminpanel/base.html' %}
{% load static %}
{% block content %}
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css">
<script src="https://kit.fontawesome.com/e4f8bd703b.js" crossorigin="anonymous"></script>
<style>
  body {
    background: #f7f7f7;
  }
  
  .table {
    border-spacing: 0 0.85rem !important;
  }
  
  .table .dropdown {
    display: inline-block;
  }
  
  .table td,
  .table th {
    vertical-align: middle;
    margin-bottom: 10px;
    border: none;
  }
  
  .table thead tr,
  .table thead th {
    border: none;
    font-size: 12px;
    letter-spacing: 1px;
    text-transform: uppercase;
    background: transparent;
  }
  
  .table td {
    background: #fff;
  }
  
  .table td:first-child {
    border-top-left-radius: 10px;
    border-bottom-left-radius: 10px;
  }
  
  .table td:last-child {
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
  }
  
  .avatar {
    width: 2.75rem;
    height: 2.75rem;
    line-height: 3rem;
    border-radius: 50%;
    display: inline-block;
    background: transparent;
    position: relative;
    text-align: center;
    color: #868e96;
    font-weight: 700;
    vertical-align: bottom;
    font-size: 1rem;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
  
  .avatar-sm {
    width: 2.5rem;
    height: 2.5rem;
    font-size: 0.83333rem;
    line-height: 1.5;
  }
  
  .avatar-img {
    width: 100%;
    height: 100%;
    -o-object-fit: cover;
    object-fit: cover;
  }
  
  .avatar-blue {
    background-color: #c8d9f1;
    color: #467fcf;
  }
  
  table.dataTable.dtr-inline.collapsed
    > tbody
    > tr[role="row"]
    > td:first-child:before,
  table.dataTable.dtr-inline.collapsed
    > tbody
    > tr[role="row"]
    > th:first-child:before {
    top: 28px;
    left: 14px;
    border: none;
    box-shadow: none;
  }
  
  table.dataTable.dtr-inline.collapsed > tbody > tr[role="row"] > td:first-child,
  table.dataTable.dtr-inline.collapsed > tbody > tr[role="row"] > th:first-child {
    padding-left: 48px;
  }
  
  table.dataTable > tbody > tr.child ul.dtr-details {
    width: 100%;
  }
  
  table.dataTable > tbody > tr.child span.dtr-title {
    min-width: 50%;
  }
  
  table.dataTable.dtr-inline.collapsed > tbody > tr > td.child,
  table.dataTable.dtr-inline.collapsed > tbody > tr > th.child,
  table.dataTable.dtr-inline.collapsed > tbody > tr > td.dataTables_empty {
    padding: 0.75rem 1rem 0.125rem;
  }
  
  div.dataTables_wrapper div.dataTables_length label,
  div.dataTables_wrapper div.dataTables_filter label {
    margin-bottom: 0;
  }
  
  @media (max-width: 767px) {
    div.dataTables_wrapper div.dataTables_paginate ul.pagination {
      -ms-flex-pack: center !important;
      justify-content: center !important;
      margin-top: 1rem;
    }
  }
  
  .btn-icon {
    background: #fff;
  }
  .btn-icon .bx {
    font-size: 20px;
  }
  
  .btn .bx {
    vertical-align: middle;
    font-size: 20px;
  }
  
  .dropdown-menu {
    padding: 0.25rem 0;
  }
  
  .dropdown-item {
    padding: 0.5rem 1rem;
  }
  
  .badge {
    padding: 0.5em 0.75em;
  }
  
  .badge-success-alt {
    background-color: #d7f2c2;
    color: #7bd235;
  }
  
  .table a {
    color: #212529;
  }
  
  .table a:hover,
  .table a:focus {
    text-decoration: none;
  }
  
  table.dataTable {
    margin-top: 12px !important;
  }
  
  .icon > .bx {
    display: block;
    min-width: 1.5em;
    min-height: 1.5em;
    text-align: center;
    font-size: 1.0625rem;
  }
  
  .btn {
    font-size: 0.9375rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
  }
  
  .avatar-blue {
        background-color: #c8d9f1;
        color: #467fcf;
      }
  
      .avatar-pink {
        background-color: #fcd3e1;
        color: #f66d9b;
      }
</style>
<div class="content-body">

  <div class="container-fluid">
    <div class="row py-5">
      <div class="col-12">
        <table id="example2" class="table table-hover responsive nowrap" style="width:100%">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Contact No.</th>
              <th>Enquiry</th>
              <th>Message</th>
              <th>Status</th>
              <th>Remark</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for item in contactUs %}
            <tr>
              <td>{{ item.cname }}</td>
              <td>{{ item.cmail }}</td>
              <td>{{ item.cphone }}</td>
              <td>{{ item.cenquiry }}</td>            
              <td>{{ item.cmessage }}</td>            
              <td>{{ item.cstatus }}</td>
              <td>{{ item.cremark }}</td>
              <td>
                <div class="dropdown">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal1" data-toggle="tooltip" data-placement="top"
                          title="Actions" style="background-color: goldenrod;">Update Status</button>
                  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                    <a class="dropdown-item" href="#"><i class="bx bxs-pencil mr-2"></i> Edit Profile</a>
                    <a class="dropdown-item text-danger" href="#"><i class="bx bxs-trash mr-2"></i> Remove</a>
                  </div>
                </div>
              </td>
            </tr>
            
            <div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Update Status</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeDialog('{{ item.id }}');"></button>
                  </div>
                  <div class="modal-body">
                    <form method="post" action="{% url 'eshikshaadminpanelapp:contact_us' %}">
                        {% csrf_token %}
                        <label class="form-label" for="status">Status:</label>
                        <select class="form-select mb-2" id="status-{{ item.id }}" name="status">
                            <option value="" selected>-- selected --</option>
                            {% for status in statuses %}
                            <option value="{{ status.0 }}" class="{% if status.0 == item.cstatus %} selected {% endif %}">{{ status.1 }}</option>
                            {% endfor %}
                        </select>
                        <label class="form-label" for="remark">Remark:</label>
                        <textarea class="form-control mb-2" id="remark-{{ item.id }}" name="remark">{{ item.cremark }}</textarea>
                        <div class="modal-footer">
                          <button type="submit" class="btn bt2 btn-primary" id="save-changes-btn" onclick="updateContact('{{ item.id }}')">Save changes</button>
                        </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <div id="error-message" class="alert alert-danger" style="display: none;">
              Please fill out all required fields.
            </div>
            <div id="success-message" class="alert alert-success" style="display: none;">
              Changes saved successfully!
            </div>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
<!-- <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script> -->
<script>
  $(document).ready(function() {
    $("#example2").DataTable({
      aaSorting: [],
      responsive: true,
  
      columnDefs: [
        {
          responsivePriority: 1,
          targets: 0
        },
        {
          responsivePriority: 2,
          targets: -1
        }
      ]
    });
  
    $(".dataTables_filter input")
      .attr("placeholder", "Search here...")
      .css({
        width: "300px",
        display: "inline-block"
      });
  
    $('[data-toggle="tooltip"]').tooltip();
  });
 
</script>

<script>
  function updateContact(id) {
    const status = document.getElementById(`status-${id}`).value;
    const remark = document.getElementById(`remark-${id}`).value;

    // Close the modal
    const modal = new bootstrap.Modal(document.getElementById('exampleModal1'));
    modal.hide();

    
    // Perform the AJAX request
    $.ajax({
        type: "POST",
        url: "{% url 'eshikshaadminpanelapp:update_contact_status' %}",
        data: {
            csrfmiddlewaretoken: "{{ csrf_token }}",
            contact_id: id,
            status: status,
            remark: remark
        },
        success: function (response) {
            if (response.status === "success") {
                // Update the displayed status and remark in the table
                const statusCell = document.querySelector(`#example2 #row-${id} .status`);
                const remarkCell = document.querySelector(`#example2 #row-${id} .remark`);
                statusCell.textContent = status;
                remarkCell.textContent = remark;

                // Display the success message
                const successMessage = document.getElementById('success-message');
                successMessage.style.display = 'block';

                // Simulate a delay before the success message disappears
                setTimeout(function () {
                    successMessage.style.display = 'none';
                }, 3000);

                // Close the dialog
                closeDialog(id);
            } else {
                alert("Failed to update contact");
            }
        },
        error: function (xhr, errmsg, err) {
            console.log(xhr.status + ":" + xhr.responseText);
        }
      });
      $(".bt2").click(function(event) {
        event.preventDefault();
        const itemId = $(this).data("item-id");
        updateContact(itemId);
      });
}
</script>



{% endblock %}